<UPDATED_CODE>{% extends 'base.html' %}

{% block title %}Сервисный центр - Автосалон "Русская душа"{% endblock %}

{% block content %}
<div class="w-full max-w-[1280px] mx-auto px-4 py-8">
<!-- Заголовок и основное изображение -->
<div class="mb-12">
  <div class="relative rounded-xl overflow-hidden shadow-lg mb-8">
    <img src="/static/img/service_centre.jpg" alt="Сервисный центр" class="w-full h-[400px] object-cover">
    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end">
      <div class="p-8 text-white">
        <h2 class="text-3xl font-bold mb-2">Профессиональное обслуживание вашего автомобиля</h2>
        <p class="text-xl">Доверьте свой автомобиль профессионалам</p>
      </div>
    </div>
  </div>
</div>
  
<!-- Почему выбирают нас -->
<div class="mb-16">
  <h2 class="text-3xl font-bold text-primary mb-10 text-center">Почему выбирают нас</h2>
    
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    <!-- Преимущество 1 -->
    <div class="bg-base-100 rounded-xl shadow-md p-6 text-center hover:shadow-xl transition-shadow">
      <div class="flex justify-center mb-4">
        <span class="icon-[tabler--coin] size-16 text-accent"></span>
      </div>
      <h3 class="text-xl font-bold mb-3">Самые выгодные цены</h3>
      <p class="text-base-content/70">
        Мы предлагаем конкурентоспособные цены на все виды работ и запчасти. Регулярные акции и специальные предложения помогут вам сэкономить.
      </p>
    </div>
      
    <!-- Преимущество 2 -->
    <div class="bg-base-100 rounded-xl shadow-md p-6 text-center hover:shadow-xl transition-shadow">
      <div class="flex justify-center mb-4">
        <span class="icon-[tabler--tools] size-16 text-accent"></span>
      </div>
      <h3 class="text-xl font-bold mb-3">Качественные запчасти</h3>
      <p class="text-base-content/70">
        Мы используем только оригинальные запчасти и высококачественные аналоги от проверенных производителей, что гарантирует долговечность ремонта.
      </p>
    </div>
      
    <!-- Преимущество 3 -->
    <div class="bg-base-100 rounded-xl shadow-md p-6 text-center hover:shadow-xl transition-shadow">
      <div class="flex justify-center mb-4">
        <span class="icon-[tabler--user-check] size-16 text-accent"></span>
      </div>
      <h3 class="text-xl font-bold mb-3">Профессиональные мастера</h3>
      <p class="text-base-content/70">
        Наши мастера имеют многолетний опыт работы и регулярно проходят обучение, чтобы быть в курсе последних технологий в автомобильной индустрии.
      </p>
    </div>
      
    <!-- Преимущество 4 -->
    <div class="bg-base-100 rounded-xl shadow-md p-6 text-center hover:shadow-xl transition-shadow">
      <div class="flex justify-center mb-4">
        <span class="icon-[tabler--clock] size-16 text-accent"></span>
      </div>
      <h3 class="text-xl font-bold mb-3">Быстрый ремонт</h3>
      <p class="text-base-content/70">
        Мы ценим ваше время, поэтому стремимся выполнить все работы максимально быстро, не теряя в качестве. Большинство работ выполняется в день обращения.
      </p>
    </div>
      
    <!-- Преимущество 5 -->
    <div class="bg-base-100 rounded-xl shadow-md p-6 text-center hover:shadow-xl transition-shadow">
      <div class="flex justify-center mb-4">
        <span class="icon-[tabler--shield-check] size-16 text-accent"></span>
      </div>
      <h3 class="text-xl font-bold mb-3">Гарантия на все виды работ</h3>
      <p class="text-base-content/70">
        Мы предоставляем гарантию на все выполненные работы и установленные запчасти. Вы можете быть уверены в качестве нашего сервиса.
      </p>
    </div>
      
    <!-- Преимущество 6 -->
    <div class="bg-base-100 rounded-xl shadow-md p-6 text-center hover:shadow-xl transition-shadow">
      <div class="flex justify-center mb-4">
        <span class="icon-[tabler--coffee] size-16 text-accent"></span>
      </div>
      <h3 class="text-xl font-bold mb-3">Комфортная зона ожидания</h3>
      <p class="text-base-content/70">
        Пока ваш автомобиль обслуживается, вы можете отдохнуть в нашей комфортной зоне ожидания с бесплатным Wi-Fi, кофе и прохладительными напитками.
      </p>
    </div>
  </div>
</div>
  
<!-- Наши услуги -->
<div class="mb-16">
  <h2 class="text-3xl font-bold text-primary mb-10 text-center">Наши услуги</h2>
    
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Услуга 1 -->
    <div class="bg-base-100 rounded-xl shadow-md overflow-hidden flex flex-col md:flex-row">
      <div class="md:w-1/3 bg-primary flex items-center justify-center p-6">
        <span class="icon-[tabler--engine] size-16 text-white"></span>
      </div>
      <div class="md:w-2/3 p-6">
        <h3 class="text-xl font-bold mb-2">Техническое обслуживание</h3>
        <p class="text-base-content/70">
          Регулярное ТО по регламенту производителя, замена масла, фильтров и других расходных материалов.
        </p>
      </div>
    </div>
      
    <!-- Услуга 2 -->
    <div class="bg-base-100 rounded-xl shadow-md overflow-hidden flex flex-col md:flex-row">
      <div class="md:w-1/3 bg-primary flex items-center justify-center p-6">
        <span class="icon-[tabler--car] size-16 text-white"></span>
      </div>
      <div class="md:w-2/3 p-6">
        <h3 class="text-xl font-bold mb-2">Диагностика</h3>
        <p class="text-base-content/70">
          Компьютерная диагностика, проверка ходовой части, тормозной системы и других узлов автомобиля.
        </p>
      </div>
    </div>
      
    <!-- Услуга 3 -->
    <div class="bg-base-100 rounded-xl shadow-md overflow-hidden flex flex-col md:flex-row">
      <div class="md:w-1/3 bg-primary flex items-center justify-center p-6">
        <span class="icon-[tabler--tools] size-16 text-white"></span>
      </div>
      <div class="md:w-2/3 p-6">
        <h3 class="text-xl font-bold mb-2">Ремонт двигателя</h3>
        <p class="text-base-content/70">
          Капитальный и текущий ремонт двигателей любой сложности с использованием качественных запчастей.
        </p>
      </div>
    </div>
      
    <!-- Услуга 4 -->
    <div class="bg-base-100 rounded-xl shadow-md overflow-hidden flex flex-col md:flex-row">
      <div class="md:w-1/3 bg-primary flex items-center justify-center p-6">
        <span class="icon-[tabler--manual-gearbox] size-16 text-white"></span>
      </div>
      <div class="md:w-2/3 p-6">
        <h3 class="text-xl font-bold mb-2">Ремонт трансмиссии</h3>
        <p class="text-base-content/70">
          Диагностика и ремонт МКПП, АКПП, вариаторов и роботизированных коробок передач.
        </p>
      </div>
    </div>
  </div>
</div>
  
<!-- Форма для записи -->
<div class="bg-base-100 rounded-xl shadow-lg p-8 mb-12">
  <h2 class="text-3xl font-bold text-primary mb-6 text-center">Запись на сервис</h2>
  <p class="text-center text-base-content/70 mb-8">
    Заполните форму ниже, и наш менеджер свяжется с вами для подтверждения записи
  </p>
    
<form action="{% url 'service:service_center' %}" method="post" class="max-w-2xl mx-auto" id="service-form">
  {% csrf_token %}
    
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="form-control">
          <label class="label" for="id_name">
              <span class="label-text font-medium">Ваше имя</span>
          </label>
          {{ form.name }}
          {% if form.name.errors %}
              <div class="text-red-500 text-sm mt-1">{{ form.name.errors.0 }}</div>
          {% endif %}
      </div>
        
      <div class="form-control">
          <label class="label" for="id_phone">
              <span class="label-text font-medium">Телефон</span>
          </label>
          {{ form.phone }}
          {% if form.phone.errors %}
              <div class="text-red-500 text-sm mt-1">{{ form.phone.errors.0 }}</div>
          {% endif %}
      </div>
        
      <div class="form-control">
          <label class="label" for="id_car_model">
              <span class="label-text font-medium">Марка и модель автомобиля</span>
          </label>
          {{ form.car_model }}
          {% if form.car_model.errors %}
              <div class="text-red-500 text-sm mt-1">{{ form.car_model.errors.0 }}</div>
          {% endif %}
      </div>
        
      <div class="form-control">
          <label class="label" for="id_service_date">
              <span class="label-text font-medium">Предпочтительная дата</span>
          </label>
          {{ form.service_date }}
          {% if form.service_date.errors %}
              <div class="text-red-500 text-sm mt-1">{{ form.service_date.errors.0 }}</div>
          {% endif %}
      </div>
        
      <div class="form-control">
          <label class="label" for="id_service_time">
              <span class="label-text font-medium">Время записи</span>
          </label>
          {{ form.service_time }}
          {% if form.service_time.errors %}
              <div class="text-red-500 text-sm mt-1">{{ form.service_time.errors.0 }}</div>
          {% endif %}
          <div id="time-loading" class="text-sm text-gray-500 mt-1 hidden">
              Загрузка доступного времени...
          </div>
      </div>
        
      <div class="form-control md:col-span-2">
          <label class="label" for="id_service_type">
              <span class="label-text font-medium">Тип обслуживания</span>
          </label>
          {{ form.service_type }}
          {% if form.service_type.errors %}
              <div class="text-red-500 text-sm mt-1">{{ form.service_type.errors.0 }}</div>
          {% endif %}
      </div>
        
      <div class="form-control md:col-span-2">
          <label class="label" for="id_comments">
              <span class="label-text font-medium">Комментарии</span>
          </label>
          {{ form.comments }}
          {% if form.comments.errors %}
              <div class="text-red-500 text-sm mt-1">{{ form.comments.errors.0 }}</div>
          {% endif %}
      </div>
  </div>
    
  <!-- Отображение общих ошибок формы -->
  {% if form.non_field_errors %}
      <div class="alert alert-error mb-6">
          <div class="flex">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div>
                  {% for error in form.non_field_errors %}
                      <span>{{ error }}</span>
                  {% endfor %}
              </div>
          </div>
      </div>
  {% endif %}
    
  <div class="form-control mb-6">
      <label class="label cursor-pointer justify-start gap-2">
          <input type="checkbox" name="agree_terms" class="checkbox checkbox-primary" required>
          <span class="label-text">Я согласен на обработку персональных данных</span>
      </label>
  </div>
    
  <div class="flex justify-center">
      <button type="submit" class="btn btn-primary btn-lg gap-2" id="submit-btn">
          <span class="icon-[tabler--calendar-plus] size-5"></span>
          Записаться на сервис
      </button>
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const dateInput = document.getElementById('id_service_date');
  const timeSelect = document.getElementById('id_service_time');
  const timeLoading = document.getElementById('time-loading');
  const submitBtn = document.getElementById('submit-btn');
    
  // Функция для загрузки доступного времени
  function loadAvailableTimes(date) {
      if (!date) {
          // Если дата не выбрана, показываем все времена
          resetTimeOptions();
          return;
      }
        
      // Показываем индикатор загрузки
      timeLoading.classList.remove('hidden');
      timeSelect.disabled = true;
        
      // AJAX запрос для получения доступного времени
      fetch(`{% url 'service:get_available_times' %}?date=${date}`)
          .then(response => response.json())
          .then(data => {
              if (data.error) {
                  console.error('Ошибка:', data.error);
                  resetTimeOptions();
                  return;
              }
                
              // Очищаем текущие опции
              timeSelect.innerHTML = '<option value="" disabled selected>Выберите время</option>';
                
              // Добавляем доступные времена
              if (data.available_times && data.available_times.length > 0) {
                  data.available_times.forEach(time => {
                      const option = document.createElement('option');
                      option.value = time.value;
                      option.textContent = time.display;
                      timeSelect.appendChild(option);
                  });
                    
                  timeSelect.disabled = false;
              } else {
                  // Если нет доступного времени
                  const option = document.createElement('option');
                  option.value = '';
                  option.textContent = 'Нет доступного времени на эту дату';
                  option.disabled = true;
                  timeSelect.appendChild(option);
                  timeSelect.disabled = true;
              }
          })
          .catch(error => {
              console.error('Ошибка при загрузке времени:', error);
              resetTimeOptions();
          })
          .finally(() => {
              timeLoading.classList.add('hidden');
          });
  }
    
  // Функция для сброса опций времени к исходному состоянию
  function resetTimeOptions() {
      timeSelect.innerHTML = `
          <option value="" disabled selected>Выберите время</option>
          <option value="09:00">09:00</option>
          <option value="10:00">10:00</option>
          <option value="11:00">11:00</option>
          <option value="12:00">12:00</option>
          <option value="13:00">13:00</option>
          <option value="14:00">14:00</option>
          <option value="15:00">15:00</option>
          <option value="16:00">16:00</option>
          <option value="17:00">17:00</option>
          <option value="18:00">18:00</option>
      `;
      timeSelect.disabled = false;
  }
    
  // Обработчик изменения даты
  dateInput.addEventListener('change', function() {
      const selectedDate = this.value;
      loadAvailableTimes(selectedDate);
  });
    
  // Валидация формы перед отправкой
  document.getElementById('service-form').addEventListener('submit', function(e) {
      const date = dateInput.value;
      const time = timeSelect.value;
      const agreeTerms = document.querySelector('input[name="agree_terms"]').checked;
        
      if (!date) {
          e.preventDefault();
          alert('Пожалуйста, выберите дату');
          return;
      }
        
      if (!time) {
          e.preventDefault();
          alert('Пожалуйста, выберите время');
          return;
      }
        
      if (!agreeTerms) {
          e.preventDefault();
          alert('Необходимо согласиться на обработку персональных данных');
          return;
      }
        
      // Блокируем кнопку отправки для предотвращения двойной отправки
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading loading-spinner"></span> Отправка...';
  });
    
  // Если дата уже выбрана при загрузке страницы (например, при ошибке валидации)
  if (dateInput.value) {
      loadAvailableTimes(dateInput.value);
  }
});
</script>
{% endblock %}